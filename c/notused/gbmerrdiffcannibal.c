/******************************************************************************

  Copyright Netlabs, 1998, this code may not be used for any military purpose

******************************************************************************/


#include "gbmcannibal.h"

static BYTE GBMNearestIndex( BYTE value, BYTE ab[], unsigned short cb );
static BOOL GBMErrDiff( BYTE *pbErrDiff,
                        GBM *gbm,
                        BYTE *src,
                        BYTE *dest,
                        int dest_bpp,
                        void( *errdiff_line )(  BYTE *pbErrDiff,
                                                BYTE *src,
                                                BYTE *dest,
                                                short *errs,
                                                int cx ) );
static BYTE GBMCalcNearest( BYTE r, BYTE g, BYTE b);
static BYTE GBMNearestColor( BYTE r, BYTE g, BYTE b );

// Set up a memory pool with some global data
BYTE *GBMErrInitialize( void )
{
    int i;
    BYTE *pbMem;
    BYTE *usat;
    short *ssat;
    BYTE *index4;
    BYTE *index6;
    BYTE *index7;
    BYTE *index8;
    BYTE *index16;
    USHORT *randtab;
    BYTE scale4[]   = { 0, 85, 170, 255 };
    BYTE scale6[]   = { 0, 51, 102, 153, 204, 255 };
    BYTE scale7[]   = { 0, 43,  85, 128, 170, 213, 255 };
    BYTE scale8[]   = { 0, 36,  73, 109, 146, 182, 219, 255 };
    BYTE scale16[]  = { 0, 17,  34,  51,  68,  85, 102, 119, 136, 153, 170, 187, 204, 221, 238, 255 };
    FILE *fp;

    DosAllocMem( ( PPVOID )&pbMem, 4608L, PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( pbMem == NULL )
    {
        return( NULL );
    }

    usat    =   pbMem;
    ssat    =   ( short * )( pbMem + 768 );         // +size taken by lusat
    index4  =   ( BYTE * )( ssat + 1024 );          // +size taken by lssat
    index6  =   index4  + 256;                      // +size taken by index4
    index7  =   index6  + 256;                      // +size taken by index6
    index8  =   index7  + 256;                      // +size taken by index7
    index16 =   index8  + 256;                      // +size taken by index8
    randtab =   ( USHORT * )( index16 + 256 );      // +size taken by index16

    memset( usat, 0, 256 );
    for( i = 0; i < 256; i++ )
    {
        *( usat + i +  256 ) = ( BYTE )i;
    }
    memset( usat + 512, 0xff, 256 );

    for( i = -512; i < -256; i++ )
    {
        *( ssat + i + 512 ) = -256;
    }
    for( i = -256; i < 256; i++ )
    {
        *( ssat + i + 512 ) = i;
    }
    for( i = 256; i < 512; i++ )
    {
        *( ssat + i + 512 ) = 0xff;
    }

        /* For 7 Red x 8 Green x 4 Blue palettes etc. */
    for( i = 0; i < 256; i++ )
    {
        *( index4 + i )     = GBMNearestIndex( ( BYTE )i, scale4 , sizeof( scale4 ) );
        *( index6 + i )     = GBMNearestIndex( ( BYTE )i, scale6 , sizeof( scale6 ) );
        *( index7 + i )     = GBMNearestIndex( ( BYTE )i, scale7 , sizeof( scale7 ) );
        *( index8 + i )     = GBMNearestIndex( ( BYTE )i, scale8 , sizeof( scale8 ) );
        *( index16 + i )    = GBMNearestIndex( ( BYTE )i, scale16, sizeof( scale16 ) );
    }

        /* For faster random number calculation */

    for( i = 0; i < 256; i++ )
    {
        *( randtab + i ) = ( USHORT )( rand() % ( 51*256 ) );
    }

    return( pbMem );
}

// vga palette
void GBMErrDiffPalVGA( BYTE *pbErrDiff, GBMRGB *gbmrgb )
{
    GBMRGB gbmrgb_vga[] = { 0,      0,      0,
                            128,    0,      0,
                            0,      128,    0,
                            128,    128,    0,
                            0,      0,      128,
                            128,    0,      128,
                            0,      128,    128,
                            128,    128,    128,
                            204,    204,    204,
                            255,    0,      0,
                            0,      255,    0,
                            255,    255,    0,
                            0,      0,      255,
                            255,    0,      255,
                            0,      255,    255,
                            255,    255,    255 };

    memcpy( ( char * )gbmrgb, ( char * )gbmrgb_vga, sizeof( gbmrgb_vga ) );

    return;
}

BOOL GBMErrDiffVGA( BYTE *pbErrDiff, GBM *gbm, BYTE *data24, BYTE *data4)
{
    return( GBMErrDiff( pbErrDiff, gbm, data24, data4, 4, GBMErrDiffLineVGA ) );
}

void GBMErrDiffLineVGA( BYTE *pbErrDiff, BYTE *src, BYTE *dest, short *errs, int cx )
{
    BOOL left = TRUE;
    int x;
    int ptr = 0;
    int randinx;
    GBMRGB gbmrgb_vga[] = { 0,      0,      0,
                            128,    0,      0,
                            0,      128,    0,
                            128,    128,    0,
                            0,      0,      128,
                            128,    0,      128,
                            0,      128,    128,
                            128,    128,    128,
                            204,    204,    204,
                            255,    0,      0,
                            0,      255,    0,
                            255,    255,    0,
                            0,      0,      255,
                            255,    0,      255,
                            0,      255,    255,
                            255,    255,    255 };

    /* Step 1: Add error terms to newly supplied line */

    for( x = 0; x < cx * 3; x++ )
    {
        *( src + x ) = USAT_ADD( pbErrDiff, ( int )*( src + x ), ( int )*( errs + x ) );

        /* Step 2: Zero out error terms */

        memset( errs, 0, ( cx + 1 ) * 3 * sizeof( *errs ) );

        /* Step 3: Go along data, finding nearest colour and propagating error */

        randinx = rand();

        for( x = 0; x < cx; x++ )
        {
            BYTE    b     = *src++;
            BYTE    g     = *src++;
            BYTE    r     = *src++;
            BYTE    bi    = GBMNearestColor( r, g, b );
            int     be    = ( int )b - ( int )gbmrgb_vga[ bi ].Blue;
            int     ge    = ( int )g - ( int )gbmrgb_vga[ bi ].Green;
            int     re    = ( int )r - ( int )gbmrgb_vga[ bi ].Red;
            USHORT  rn    = RANDTAB( pbErrDiff )[ ( BYTE )( randinx++ ) ];
            int     right = ( rn >> 8 );
            int     down  = ( ( rn & 0xff ) % ( 63 - right ) );
            int     be1   = ( ( be * right ) >> 6 );
            int     ge1   = ( ( ge * right ) >> 6 );
            int     re1   = ( ( re * right ) >> 6 );
            int     be2   = ( ( be * down ) >> 6 );
            int     ge2   = ( ( ge * down ) >> 6 );
            int     re2   = ( ( re * down ) >> 6 );
            int     be3   = be - be1 - be2;
            int     ge3   = ge - ge1 - ge2;
            int     re3   = re - re1 - re2;

            if( left )
            {
                *dest = ( BYTE )( bi << 4 );
            }
            else
            {
                *dest++ |= bi;
            }

            left = !left;

            *src = USAT_ADD( pbErrDiff, ( int )*src, be1 );
            *( src + 1 ) = USAT_ADD( pbErrDiff, ( int )*( src + 1 ), ge1 );
            *( src + 2 ) = USAT_ADD( pbErrDiff, ( int )*( src + 2 ), re1 );

            *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr ), be2 );
            *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge2 );
            *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re2 );

            ptr += 3;

            *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr ), be3 );
            *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge3 );
            *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re3 );
        }
    }

    return;
}

void GBMErrDiffPal7R8G4B( BYTE *pbErrDiff, GBMRGB *gbmrgb )
{
    BYTE volatile r;        /* C-Set/2 optimiser fix */
    BYTE volatile g;
    BYTE volatile b;
    BYTE scale4[]   = { 0, 85, 170, 255 };
    BYTE scale6[]   = { 0, 51, 102, 153, 204, 255 };
    BYTE scale7[]   = { 0, 43,  85, 128, 170, 213, 255 };
    BYTE scale8[]   = { 0, 36,  73, 109, 146, 182, 219, 255 };
    BYTE scale16[]  = { 0, 17,  34,  51,  68,  85, 102, 119, 136, 153, 170, 187, 204, 221, 238, 255 };

    memset( gbmrgb, 0x80, 256 * sizeof( GBMRGB ) );

    for( r = 0; r < 7; r++ )
    {
        for ( g = 0; g < 8; g++ )
        {
            for ( b = 0; b < 4; b++ )
            {
                gbmrgb->Red     = scale7[ r ];
                gbmrgb->Green   = scale8[ g ];
                gbmrgb->Blue    = scale4[ b ];
                gbmrgb++;
            }
        }
    }

    return;
}

BOOL GBMErrDiff7R8G4B( BYTE *pbErrDiff, GBM *gbm, BYTE *data24, BYTE *data8 )
{
    return( GBMErrDiff( pbErrDiff, gbm, data24, data8, 8, GBMErrDiffLine7R8G4B ) );
}

void GBMErrDiffLine7R8G4B( BYTE *pbErrDiff, BYTE *src, BYTE *dest, short *errs, int cx)
{
    int x;
    int ptr = 0;
    int randinx;
    BYTE scale4[]   = { 0, 85, 170, 255 };
    BYTE scale6[]   = { 0, 51, 102, 153, 204, 255 };
    BYTE scale7[]   = { 0, 43,  85, 128, 170, 213, 255 };
    BYTE scale8[]   = { 0, 36,  73, 109, 146, 182, 219, 255 };
    BYTE scale16[]  = { 0, 17,  34,  51,  68,  85, 102, 119, 136, 153, 170, 187, 204, 221, 238, 255 };

    /* Step 1: Add error terms to newly supplied line */

    for( x = 0; x < cx * 3; x++ )
    {
        *( src + x ) = USAT_ADD( pbErrDiff, ( int )*( src + x ), ( int )*( errs + x ) );
    }
    /* Step 2: Zero out error terms */

    memset( errs, 0, ( cx + 1 ) * 3 * sizeof( *errs ) );

    /* Step 3: Go along data, finding nearest colour and propagating error */

    randinx = rand();

    for( x = 0; x < cx; x++ )
    {
        BYTE b     = *src++;
        BYTE g     = *src++;
        BYTE r     = *src++;

        BYTE bi    = INDEX4( pbErrDiff )[ b ];
        BYTE gi    = INDEX8( pbErrDiff )[ g ];
        BYTE ri    = INDEX7( pbErrDiff )[ r ];

        int  be    = b - ( ( int )scale4[ bi ] );
        int  ge    = g - ( ( int )scale8[ gi ] );
        int  re    = r - ( ( int )scale7[ ri ] );

        USHORT rn    = RANDTAB( pbErrDiff )[ ( BYTE )( randinx++ ) ];

        int  right = ( rn >> 8 );
        int  down  = ( ( rn & 0xff ) % ( 63 - right ) );
        int  be1   = ( ( be * right ) >> 6 );
        int  ge1   = ( ( ge * right ) >> 6 );
        int  re1   = ( ( re * right ) >> 6 );
        int  be2   = ( ( be * down ) >> 6 );
        int  ge2   = ( ( ge * down ) >> 6 );
        int  re2   = ( ( re * down ) >> 6 );
        int  be3   = be - be1 - be2;
        int  ge3   = ge - ge1 - ge2;
        int  re3   = re - re1 - re2;

        *dest++ = ( BYTE ) ( 4 * ( 8 * ri + gi ) + bi );

        *src            = USAT_ADD( pbErrDiff, ( int )*src, be1 );
        *( src + 1 )    = USAT_ADD( pbErrDiff, ( int )*( src + 1 ), ge1 );
        *( src + 2 )    = USAT_ADD( pbErrDiff, ( int )*( src + 2 ), re1 );

        *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr ), be2 );
        *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge2 );
        *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re2 );

        ptr += 3;

        *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr ), be3 );
        *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge3 );
        *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re3 );
    }

    return;
}

BOOL GBMErrDiff24( BYTE *pbErrDiff, GBM *gbm, BYTE *data24, BYTE *data24a, BYTE rm, BYTE gm, BYTE bm)
{
    int     stride = ( ( gbm->w * 3 + 3 ) & ~3 );
    BYTE    *buf;
    short   *errs;
    int     y;

    DosAllocMem( ( PPVOID )&buf, stride + 3, PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( buf == NULL )
    {
        return( FALSE );
    }
    DosAllocMem(    ( PPVOID )&errs,
                    ( gbm->w + 1 ) * 3 * sizeof( short ),
                    PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( errs == NULL )
    {
        DosFreeMem( buf );
        return( FALSE );
    }

    memset( errs, 0, ( gbm->w + 1 ) * 3 * sizeof( short ) );

    for( y = 0; y < gbm->h; y++ )
    {
        memcpy( buf, data24 + y * stride, stride );
        GBMErrDiffLine24( pbErrDiff, buf, data24a + y * stride, errs, gbm->w, rm, gm, bm );
    }

    DosFreeMem( buf );
    DosFreeMem( errs );

    return( TRUE );
}

void GBMErrDiffLine24(  BYTE *pbErrDiff,
                        BYTE *src,
                        BYTE *dest,
                        short *errs,
                        int cx,
                        BYTE rm,
                        BYTE gm,
                        BYTE bm )
{
    int x;
    int ptr = 0;
    int randinx;

    /* Step 1: Add error terms to newly supplied line */

    for( x = 0; x < cx * 3; x++ )
    {
        *( src + x ) = USAT_ADD( pbErrDiff, ( int )*( src + x ), ( int )*( errs + x ) );
    }

    /* Step 2: Zero out error terms */

    memset( errs, 0, cx * 3 * sizeof( *errs ) );

    /* Step 3: Go along data, finding nearest colour and propagating error */

    randinx = rand();

    for ( x = 0; x < cx; x++ )
    {
        BYTE b     = *src++;
        BYTE g     = *src++;
        BYTE r     = *src++;

        BYTE bi    = ( b & bm );
        BYTE gi    = ( g & gm );
        BYTE ri    = ( r & rm );
        int  be    = b - ( int )bi;
        int  ge    = g - ( int )gi;
        int  re    = r - ( int )ri;

        USHORT rn    = RANDTAB( pbErrDiff )[ ( BYTE )( randinx++ ) ];

        int  right = ( rn >> 8 );
        int  down  = ( ( rn & 0xff ) % ( 63 - right ) );
        int  be1   = ( ( be * right ) >> 6 );
        int  ge1   = ( ( ge * right ) >> 6 );
        int  re1   = ( ( re * right ) >> 6 );
        int  be2   = ( ( be * down ) >> 6 );
        int  ge2   = ( ( ge * down ) >> 6 );
        int  re2   = ( ( re * down ) >> 6 );
        int  be3   = be - be1 - be2;
        int  ge3   = ge - ge1 - ge2;
        int  re3   = re - re1 - re2;

        *dest++ = bi;
        *dest++ = gi;
        *dest++ = ri;

        *src            = USAT_ADD( pbErrDiff, ( int )*src, be1 );
        *( src + 1 )    = USAT_ADD( pbErrDiff, ( int )*( src + 1 ), ge1 );
        *( src + 2 )    = USAT_ADD( pbErrDiff, ( int )*( src + 2 ), re1 );

        *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr ), be2 );
        *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge2 );
        *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re2 );

        ptr += 3;

        *( errs + ptr )     = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr     ), be3 );
        *( errs + ptr + 1 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 1 ), ge3 );
        *( errs + ptr + 2 ) = SSAT_ADD( pbErrDiff, ( int )*( errs + ptr + 2 ), re3 );
    }

    return;
}

// find out the array index containing the closest thing to value
static BYTE GBMNearestIndex( BYTE value, BYTE ab[], unsigned short cb )
{
    BYTE b;
    BYTE inx;
    BYTE inx_min;
    short diff;
    short diff_min;

    b = *( ab );
    diff_min = abs( ( short )value - ( short )b );
    inx_min = 0;
    for( inx = 1; ( unsigned short )inx < cb; inx++ )
    {
        b = *( ab + inx );
        diff = abs( ( short )value - ( short )b );
        if( diff < diff_min )
        {
            diff_min = diff;
            inx_min = inx;
        }
    }
    return inx_min;
}

// run through data line by line propagating errors
static BOOL GBMErrDiff( BYTE *pbErrDiff,
                        GBM *gbm,
                        BYTE *src,
                        BYTE *dest,
                        int dest_bpp,
                        void( *errdiff_line )(  BYTE *pbErrDiff,
                                                BYTE *src,
                                                BYTE *dest,
                                                short *errs,
                                                int cx ) )
{
    int     stride_src =  ( ( gbm->w * 3 + 3 ) & ~3 );
    int     stride_dest = ( ( gbm->w * dest_bpp + 31 ) / 32 ) * 4;
    BYTE    *buf;
    short   *errs;
    int     y;

    DosAllocMem( ( PPVOID )&buf, stride_src + 3, PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( buf == NULL )
    {
        return( FALSE );
    }
    DosAllocMem(    ( PPVOID )&errs,
                    ( gbm->w + 1 ) * 3 * sizeof( short ),
                    PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( errs == NULL )
    {
        DosFreeMem( buf );
        return( FALSE );
    }

    memset( errs, 0, ( gbm->w + 1 ) * 3 * sizeof( short ) );

    for( y = 0; y < gbm->h; y++ )
    {
        memcpy( buf, src + y * stride_src, stride_src );
        ( *errdiff_line )( pbErrDiff, buf, dest + y * stride_dest, errs, gbm->w );
    }

    DosFreeMem( buf );
    DosFreeMem( errs );

    return( TRUE );
}

static BYTE GBMNearestColor( BYTE r, BYTE g, BYTE b )
{
    BYTE quick_tab[16][16][16] = {  0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,14,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,255,14,14,14,
                                    10,10,10,10,255,6,6,6,6,6,6,255,14,14,14,14,
                                    10,10,10,10,10,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,14,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,255,14,14,14,
                                    10,10,10,10,255,6,6,6,6,6,6,255,14,14,14,14,
                                    10,10,10,10,10,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,14,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,255,14,14,14,
                                    10,10,10,10,255,6,6,6,6,6,6,255,14,14,14,14,
                                    10,10,10,10,10,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    0,0,0,0,255,4,4,4,4,4,4,4,12,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,12,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,12,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,6,255,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,6,255,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,6,255,14,14,
                                    2,2,2,2,255,6,6,6,6,6,6,6,255,14,14,14,
                                    10,10,10,10,255,6,6,6,6,6,6,255,14,14,14,14,
                                    10,10,10,10,10,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    255,255,255,255,255,255,255,255,255,255,255,255,255,12,12,12,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,255,12,12,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,6,255,12,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,6,6,255,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,6,6,255,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,6,255,14,
                                    255,255,255,255,255,6,6,6,6,6,6,6,6,255,14,14,
                                    255,255,255,255,255,6,6,6,6,6,6,6,255,14,14,14,
                                    255,255,255,255,255,6,6,6,6,6,6,255,14,14,14,14,
                                    10,10,10,10,10,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,12,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,12,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,12,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,12,12,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,255,12,12,
                                    3,3,3,3,3,255,255,255,255,255,255,255,255,255,12,12,
                                    3,3,3,3,3,255,6,6,6,6,6,6,6,6,255,12,
                                    3,3,3,3,3,255,6,255,255,6,6,6,6,6,6,255,
                                    3,3,3,3,3,255,6,255,255,6,6,6,6,6,6,255,
                                    3,3,3,3,3,255,6,6,6,6,6,6,6,6,255,14,
                                    3,3,3,3,3,255,6,6,6,6,6,6,6,255,14,14,
                                    3,3,3,3,3,255,6,6,6,6,6,6,255,14,14,14,
                                    3,3,3,3,3,255,6,6,6,6,6,255,14,14,14,14,
                                    255,255,255,255,255,255,6,6,6,6,255,14,14,14,14,14,
                                    10,10,10,10,10,10,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,12,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,12,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,5,255,12,
                                    3,3,3,3,3,255,5,5,5,5,5,5,5,5,255,12,
                                    3,3,3,3,3,3,255,255,255,255,255,255,255,255,255,12,
                                    3,3,3,3,3,3,255,255,255,255,255,6,6,6,6,255,
                                    3,3,3,3,3,3,255,255,255,255,255,6,6,6,6,255,
                                    3,3,3,3,3,3,255,255,255,255,255,6,6,6,255,14,
                                    3,3,3,3,3,3,255,255,255,255,6,6,6,255,14,14,
                                    3,3,3,3,3,3,255,6,6,6,6,6,255,14,14,14,
                                    3,3,3,3,3,3,255,6,6,6,6,255,14,14,14,14,
                                    3,3,3,3,3,3,255,6,6,6,255,14,14,14,14,14,
                                    255,255,255,255,255,255,255,6,6,255,14,14,14,14,14,14,
                                    10,10,10,10,10,10,10,255,255,14,14,14,14,14,14,14,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,5,5,255,
                                    3,3,3,3,3,255,5,255,255,5,5,5,5,5,5,255,
                                    3,3,3,3,3,3,255,255,255,255,255,5,5,5,5,255,
                                    3,3,3,3,3,255,255,7,7,7,255,255,255,255,255,255,
                                    3,3,3,3,3,255,255,7,7,7,255,6,6,6,6,255,
                                    3,3,3,3,3,3,255,7,7,255,255,6,6,6,255,14,
                                    3,3,3,3,3,3,255,255,255,255,255,6,6,255,14,14,
                                    3,3,3,3,3,3,3,255,6,6,6,6,255,14,14,14,
                                    3,3,3,3,3,3,3,255,6,6,6,255,14,14,14,14,
                                    3,3,3,3,3,3,3,255,6,6,255,14,14,14,14,14,
                                    3,3,3,3,3,3,3,255,6,255,14,14,14,14,14,14,
                                    255,255,255,255,255,255,255,255,255,14,14,14,14,14,14,14,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,5,255,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,5,5,255,
                                    3,3,3,3,3,255,5,255,255,5,5,5,5,5,5,255,
                                    3,3,3,3,3,3,255,255,255,255,255,5,5,5,5,255,
                                    3,3,3,3,3,255,255,7,7,7,255,5,5,5,5,255,
                                    3,3,3,3,3,255,255,7,7,7,255,255,255,255,255,255,
                                    3,3,3,3,3,3,255,7,7,7,255,255,255,255,255,15,
                                    3,3,3,3,3,3,255,255,255,255,255,255,255,255,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,255,255,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,255,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,15,15,15,15,15,15,
                                    255,255,255,255,255,255,255,255,255,15,15,15,15,15,15,15,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,5,255,13,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,5,255,13,
                                    3,3,3,3,3,255,5,5,5,5,5,5,5,5,255,13,
                                    3,3,3,3,3,3,255,255,255,255,255,5,5,5,255,13,
                                    3,3,3,3,3,3,255,7,7,255,255,5,5,5,255,13,
                                    3,3,3,3,3,3,255,7,7,7,255,255,255,255,255,15,
                                    3,3,3,3,3,3,255,255,7,7,255,255,255,15,15,15,
                                    3,3,3,3,3,3,255,255,255,255,255,255,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,15,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,15,15,15,15,15,15,15,
                                    255,255,255,255,255,255,255,255,255,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,5,255,13,13,
                                    255,255,255,255,255,5,5,5,5,5,5,5,5,255,13,13,
                                    3,3,3,3,3,255,5,5,5,5,5,5,5,255,13,13,
                                    3,3,3,3,3,3,255,255,255,255,5,5,5,255,13,13,
                                    3,3,3,3,3,3,255,255,255,255,255,5,5,255,13,13,
                                    3,3,3,3,3,3,255,255,255,255,255,255,255,255,15,15,
                                    3,3,3,3,3,3,255,255,255,255,255,255,15,15,15,15,
                                    3,3,3,3,3,3,3,255,255,255,255,255,255,255,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,255,255,255,255,15,
                                    3,3,3,3,3,3,3,3,255,15,255,255,255,255,255,15,
                                    255,255,255,255,255,255,255,255,255,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,255,255,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    1,1,1,1,255,5,5,5,5,5,5,5,255,13,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,255,13,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,255,13,13,13,
                                    1,1,1,1,255,5,5,5,5,5,5,5,255,13,13,13,
                                    255,255,255,255,255,5,5,5,5,5,5,5,255,13,13,13,
                                    3,3,3,3,3,255,5,5,5,5,5,5,255,13,13,13,
                                    3,3,3,3,3,3,255,5,5,5,5,5,255,13,13,13,
                                    3,3,3,3,3,3,3,255,5,5,5,5,255,13,13,13,
                                    3,3,3,3,3,3,3,3,255,255,255,255,255,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,255,255,255,255,255,15,
                                    3,3,3,3,3,3,3,3,255,15,255,255,8,255,255,15,
                                    255,255,255,255,255,255,255,255,255,15,255,8,8,8,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,8,255,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    9,9,9,9,255,5,5,5,5,5,5,255,13,13,13,13,
                                    9,9,9,9,255,5,5,5,5,5,5,255,13,13,13,13,
                                    9,9,9,9,255,5,5,5,5,5,5,255,13,13,13,13,
                                    9,9,9,9,255,5,5,5,5,5,5,255,13,13,13,13,
                                    255,255,255,255,255,5,5,5,5,5,5,255,13,13,13,13,
                                    3,3,3,3,3,255,5,5,5,5,5,255,13,13,13,13,
                                    3,3,3,3,3,3,255,5,5,5,5,255,13,13,13,13,
                                    3,3,3,3,3,3,3,255,5,5,5,255,13,13,13,13,
                                    3,3,3,3,3,3,3,3,255,255,255,255,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,255,15,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,15,255,255,255,255,255,15,
                                    255,255,255,255,255,255,255,255,255,15,255,8,8,8,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,8,8,8,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,8,8,255,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    9,9,9,9,9,255,5,5,5,5,255,13,13,13,13,13,
                                    9,9,9,9,9,255,5,5,5,5,255,13,13,13,13,13,
                                    9,9,9,9,9,255,5,5,5,5,255,13,13,13,13,13,
                                    9,9,9,9,9,255,5,5,5,5,255,13,13,13,13,13,
                                    9,9,9,9,9,255,5,5,5,5,255,13,13,13,13,13,
                                    255,255,255,255,255,255,5,5,5,5,255,13,13,13,13,13,
                                    3,3,3,3,3,3,255,5,5,5,255,13,13,13,13,13,
                                    3,3,3,3,3,3,3,255,5,5,255,13,13,13,13,13,
                                    3,3,3,3,3,3,3,3,255,255,255,15,15,15,15,15,
                                    3,3,3,3,3,3,3,3,255,15,15,15,15,15,15,15,
                                    255,255,255,255,255,255,255,255,255,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,8,255,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,8,8,255,255,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,255,255,255,15,
                                    11,11,11,11,11,11,11,11,15,15,15,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    9,9,9,9,9,9,255,5,5,255,13,13,13,13,13,13,
                                    255,255,255,255,255,255,255,5,5,255,13,13,13,13,13,13,
                                    3,3,3,3,3,3,3,255,5,255,13,13,13,13,13,13,
                                    3,3,3,3,3,3,3,3,255,255,15,15,15,15,15,15,
                                    255,255,255,255,255,255,255,255,255,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,255,255,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,255,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,255,255,255,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    9,9,9,9,9,9,9,255,255,13,13,13,13,13,13,13,
                                    255,255,255,255,255,255,255,255,255,13,13,13,13,13,13,13,
                                    255,255,255,255,255,255,255,255,255,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15,
                                    11,11,11,11,11,11,11,11,15,15,15,15,15,15,15,15 };
    BYTE i;

    if( ( i = quick_tab[ r >> 4 ][ g >> 4 ][ b >> 4 ] ) != ( BYTE ) 0xff )
    {
        return( i );
    }

    return( GBMCalcNearest( r, g, b ) );
}

// calculate the nearest palette color to the given values
static BYTE GBMCalcNearest( BYTE r, BYTE g, BYTE b)
{
    long min_dist = 3L * 256L * 256L * 10L;
    BYTE bi;
    BYTE bi_min;
    GBMRGB gbmrgb_vga[] = { 0,      0,      0,
                            128,    0,      0,
                            0,      128,    0,
                            128,    128,    0,
                            0,      0,      128,
                            128,    0,      128,
                            0,      128,    128,
                            128,    128,    128,
                            204,    204,    204,
                            255,    0,      0,
                            0,      255,    0,
                            255,    255,    0,
                            0,      0,      255,
                            255,    0,      255,
                            0,      255,    255,
                            255,    255,    255 };

    for ( bi = 0; bi < 0x10; bi++ )
    {
        long b_dist = ( ( long )b - ( long )gbmrgb_vga[ bi ].Blue );
        long g_dist = ( ( long )g - ( long )gbmrgb_vga[ bi ].Green );
        long r_dist = ( ( long )r - ( long )gbmrgb_vga[ bi ].Red );
        long dist = r_dist * r_dist + g_dist * g_dist + b_dist * b_dist;

        if( bi == 7 || bi == 8 )
        {
            /* Bias away from this colour */
            dist <<= 3;
        }

        if( dist < min_dist )
        {
            min_dist = dist;
            bi_min = bi;
        }
    }

    return( bi_min );
}

// map given bitmap data to 24 bpp
BOOL GBMTo24Bit( GBM *gbm, GBMRGB *gbmrgb, char **ppchData )
{
    int     stride = ( ( gbm->w * gbm->bpp + 31 ) / 32 ) * 4;
    int     new_stride = ( ( gbm->w * 3 + 3 ) & ~3 );
    int     bytes;
    int     y;
    char    *pchDataNew;

    if( gbm -> bpp == 24 )
    {
        return( TRUE );
    }
    bytes = new_stride * gbm->h;
    DosAllocMem( ( PPVOID )&pchDataNew, bytes, PAG_READ | PAG_WRITE | PAG_COMMIT );
    if( pchDataNew == NULL )
    {
        return( FALSE );
    }

    for( y = 0; y < gbm->h; y++ )
    {
        BYTE    *src = *ppchData + y * stride;
        BYTE    *dest = pchDataNew + y * new_stride;
        int     x;

        switch( gbm->bpp )
        {
            case 1:
            {
                BYTE    c;

                for( x = 0; x < gbm->w; x++ )
                {
                    if( ( x & 7 ) == 0 )
                    {
                        c = *src++;
                    }
                    else
                    {
                        c <<= 1;
                    }

                    *dest++ = gbmrgb[ ( c & 0x80 ) != 0 ].Blue;
                    *dest++ = gbmrgb[ ( c & 0x80 ) != 0 ].Green;
                    *dest++ = gbmrgb[ ( c & 0x80 ) != 0 ].Red;
                }
            }
            break;

            case 4:
            {
                for( x = 0; x + 1 < gbm->w; x += 2 )
                {
                    BYTE    c = *src++;

                    *dest++ = gbmrgb[ c >> 4 ].Blue;
                    *dest++ = gbmrgb[ c >> 4 ].Green;
                    *dest++ = gbmrgb[ c >> 4 ].Red;
                    *dest++ = gbmrgb[ c & 15 ].Blue;
                    *dest++ = gbmrgb[ c & 15 ].Green;
                    *dest++ = gbmrgb[ c & 15 ].Red;
                }

                if ( x < gbm->w )
                {
                    BYTE    c = *src;

                    *dest++ = gbmrgb[ c >> 4 ].Blue;
                    *dest++ = gbmrgb[ c >> 4 ].Green;
                    *dest++ = gbmrgb[ c >> 4 ].Red;
                }
            }
            break;

            case 8:
            {
                for( x = 0; x < gbm->w; x++ )
                {
                    BYTE    c = *src++;

                    *dest++ = gbmrgb[ c ].Blue;
                    *dest++ = gbmrgb[ c ].Green;
                    *dest++ = gbmrgb[ c ].Red;
                }
            }
            break;
        }
    }

    DosFreeMem( *ppchData);
    *ppchData = pchDataNew;
    gbm->bpp = 24;

    return( TRUE );
}



/*************************************************************************************************************


    $Id: gbmerrdiffcannibal.c,v 1.1 1999/06/15 20:47:59 ktk Exp $
    

    $Log: gbmerrdiffcannibal.c,v $
    Revision 1.1  1999/06/15 20:47:59  ktk
    Import

    Revision 1.3  1998/09/11 03:02:32  pgarner
    Add the non-military use license

    Revision 1.2  1998/09/11 02:45:45  pgarner
    'Added

    Revision 1.1  1998/06/08 14:18:59  pgarner
    Initial Checkin



*************************************************************************************************************/

